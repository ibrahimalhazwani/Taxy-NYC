---
title: "Analysis of the taxy trasportation in NYC on January 2019"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

Install the libraries usefull for the project.
```{r}
install.packages('tidyverse')
install.packages('sf')
install.packages('dplyr')
install.packages('ggdark')
install.packages('networkD3')
```

Load the libraries for running the project.
```{r}
library(tidyverse)
library(sf)
library(dplyr)
library(ggdark)
library(networkD3)
```

Load the data, data avaiable at the website [LINK]
```{r}
yellow_df <- read_csv("data/yellow_tripdata_2019-01.csv")
green_df <- read_csv("data/green_tripdata_2019-01.csv")
fhv_df <- read_csv("data/fhv_tripdata_2019-01.csv")
map_nyc <- read_sf("data/taxi_zones.shp")
```

# Data preprocessing

Create two new column in the map dataframe so later will be possible to make the left join.
```{r}
map_nyc$PULocationID <- map_nyc$LocationID
map_nyc$DOLocationID <- map_nyc$LocationID
```

```{r}
dictionary_zone <- subset(map_nyc, select = c(zone, PULocationID, DOLocationID)) %>% 
  drop_na()
```
 
Edit the yellow cab dataframe in order to reduce the dimension and keep only the column needed for creating the map.
```{r}
yellow_df_sample_sankey <- yellow_df[sample(nrow(yellow_df), 743219), ] %>% 
  subset(select = c(PULocationID,DOLocationID)) %>%
  drop_na()

yellow_df_sample_sankey$PULocationZone <- NA
yellow_df_sample_sankey$DOLocationZone <- NA

yellow_df_sample_taxy <- yellow_df[sample(nrow(yellow_df), 3219), ] %>% 
  subset(select = c(PULocationID,DOLocationID)) %>%
  drop_na()

yellow_nyc_PUL <- left_join(yellow_df_sample_taxy,map_nyc,"PULocationID") %>%
  subset(select = c(PULocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()

yellow_nyc_DOL <- left_join(yellow_df_sample_taxy,map_nyc,"DOLocationID") %>%
  subset(select = c(DOLocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()
```

MATTEO HELP ME!
```{r}
for (item1 in yellow_df_sample_sankey$PULocationID){
  for (item2 in dictionary_zone$PULocationID){
    if (item1 == item2){
      yellow_df_sample_sankey$PULocationZone <- dictionary_zone$zone
    }
  }
}
```

Edit the green cab dataframe in order to keep only the column usefull for the creation of the map.
```{r}
green_df <- subset(green_df, select = c(lpep_pickup_datetime,lpep_dropoff_datetime,PULocationID,DOLocationID, passenger_count)) 

green_nyc_PUL <- left_join(green_df,map_nyc,"PULocationID") %>%
  subset(select = c(passenger_count,lpep_pickup_datetime,lpep_dropoff_datetime,PULocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()

green_nyc_DOL <- left_join(green_df,map_nyc,"DOLocationID") %>%
  subset(select = c(passenger_count,lpep_pickup_datetime,lpep_dropoff_datetime,DOLocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()
```

Edit the fhv dataframe by dropping all the na row and keep only the one usefull for the map.
```{r}
fhv_df <- drop_na(fhv_df)
fhv_sample <- fhv_df[sample(nrow(fhv_df), 743219), ]

fhv_nyc_PUL <- left_join(fhv_sample, map_nyc, "PULocationID") %>%
  subset(select = c(pickup_datetime,dropoff_datetime,PULocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()

fhv_nyc_DOL <- left_join(fhv_sample, map_nyc, "DOLocationID") %>%
  subset(select = c(pickup_datetime,dropoff_datetime,DOLocationID,Shape_Leng,zone,borough, geometry)) %>%
  drop_na()
```

# Data Visualization

Plot the NYC map
```{r}
df <- yellow_nyc_PUL %>% group_by(PULocationID, zone) %>%
  summarize(Count=n())

df <- left_join(df,map_nyc, 'PULocationID') %>%
  subset(select = c(PULocationID, Count,geometry))

ggplot() +
  geom_sf (data = map_nyc) +
  geom_sf (data = df, mapping = aes(fill = Count, geometry = geometry))
```

Script for creating the Sankey Diagram
```{r}
final_table <- yellow_df_sample_sankey %>% group_by(PULocationID,DOLocationID) %>%
      summarize(Count = n())

final_table_ordered <- final_table[with(final_table, order(-Count)),]

final_table_head <- head(final_table_ordered, 50)

links <- data.frame(source = final_table_head$PULocationID,
                    target = final_table_head$DOLocationID,
                    value = final_table_head$Count)

links$source <- paste0(links$source,'_source')
links$target <- paste0(links$target,'_target')

nodes <- data.frame(name=c(as.character(links$source), as.character(links$target))) %>% 
  distinct()

links$IDsource <- match(links$source, nodes$name)-1 
links$IDtarget <- match(links$target, nodes$name)-1

links$group <- as.factor(links$source)
nodes$group <- as.factor(nodes$name)

p <- sankeyNetwork(Links = links, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", 
              sinksRight=FALSE, LinkGroup="group", NodeGroup="group")
p
```


